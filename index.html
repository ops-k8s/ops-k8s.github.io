<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Kuberntes存储之configMap" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/29/Kuberntes%E5%AD%98%E5%82%A8%E4%B9%8BconfigMap/" class="article-date">
  <time datetime="2020-03-29T04:32:34.000Z" itemprop="datePublished">2020-03-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/29/Kuberntes%E5%AD%98%E5%82%A8%E4%B9%8BconfigMap/">Kuberntes存储之ConfigMap</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ConfigMap-介绍"><a href="#ConfigMap-介绍" class="headerlink" title="ConfigMap 介绍"></a>ConfigMap 介绍</h2><p>configMap 功能是在 Kubernetes 1.2 版本汇总引入，许多应用程序会从配置文件，命令行参数或者环境变量中读取配置信息，ConfigMap API 给我们提供了向容器中注入配置信息的机制，类似于配置中心。我们可以保存configMap 为一个 key/value 的单个属性，也可以使用一个配置文件或者json二进制大对象来保存整个配置。</p>
<h2 id="ConfigMap-的创建"><a href="#ConfigMap-的创建" class="headerlink" title="ConfigMap 的创建"></a>ConfigMap 的创建</h2><ul>
<li><strong>使用目录创建</strong></li>
</ul>
<p>指定目录下的所有文件都会被用在ConfigMap里面创建一个键值对，键的名字就是文件名，值为文件内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]# mkdir configmap</span><br><span class="line">configmap]# mkdir dir</span><br><span class="line">configmap]# cd dir</span><br><span class="line">dir]# echo &quot;server.port&#x3D;8109&quot; &gt; application.properties</span><br><span class="line">dir]# echo &quot;dubbo.registry.address&#x3D;zookeeper:&#x2F;&#x2F;127.0.0.1:12181&quot;  &gt; application-pro.properties</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dir]# kubectl  create configmap dubbo-config --from-file&#x3D;..&#x2F;dir&#x2F;</span><br><span class="line">dir]# kubectl  get cm dubbo-config -o yaml</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>使用文件创建</strong></li>
</ul>
<p>只要指定一个文件就可以从单个文件中创建ConfigMap</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir]# kubectl  create configmap dubbo-config-2 --from-file&#x3D;..&#x2F;dir&#x2F;application.properties</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>使用字面值创建</strong></li>
</ul>
<p>利用 <code>--from-literal</code>传递配置信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir]# kubectl  create configmap dubbo-config-3 --from-literal&#x3D;my.country&#x3D;china --from-literal&#x3D;my.name&#x3D;rex</span><br></pre></td></tr></table></figure>

<h2 id="使用-ConfigMap-数据定义容器环境变量"><a href="#使用-ConfigMap-数据定义容器环境变量" class="headerlink" title="使用 ConfigMap 数据定义容器环境变量"></a>使用 ConfigMap 数据定义容器环境变量</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 在 ConfigMap 中将环境变量定义为键值对:</span><br><span class="line">~]# kubectl create configmap special-config --from-literal&#x3D;special.how&#x3D;very</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">2. 将 ConfigMap 中定义的 special.how 值分配给 Pod 规范中的 SPECIAL_LEVEL_KEY 环境变量</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: dapi-test-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: test-container</span><br><span class="line">      image: k8s.gcr.io&#x2F;busybox</span><br><span class="line">      command: [ &quot;&#x2F;bin&#x2F;sh&quot;, &quot;-c&quot;, &quot;env&quot; ]</span><br><span class="line">      env:</span><br><span class="line">        - name: SPECIAL_LEVEL_KEY</span><br><span class="line">          valueFrom:</span><br><span class="line">            configMapKeyRef:</span><br><span class="line">              name: special-config</span><br><span class="line">              key: special.how</span><br><span class="line">  restartPolicy: Never</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl  logs dapi-test-pod|grep &quot;SPECIAL_LEVEL_KEY&quot;</span><br><span class="line">SPECIAL_LEVEL_KEY&#x3D;very</span><br></pre></td></tr></table></figure>

<h2 id="使用-ConfigMap-提供Nginx配置文件"><a href="#使用-ConfigMap-提供Nginx配置文件" class="headerlink" title="使用 ConfigMap 提供Nginx配置文件"></a>使用 ConfigMap 提供Nginx配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1. 创建 ConfigMap - nginx-cfg</span><br><span class="line">~]# cat server1.conf </span><br><span class="line">server &#123;</span><br><span class="line">    server_name www.myapp1.com;</span><br><span class="line">    listen 80;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        root &quot;&#x2F;node1&#x2F;html&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@k8s-master ~]# cat server2.conf </span><br><span class="line">server &#123;</span><br><span class="line">    server_name www.myapp2.com;</span><br><span class="line">    listen 80;</span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        root &quot;&#x2F;node2&#x2F;html&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">~]# kubectl  create configmap nginx-cfg --from-file&#x3D;.&#x2F;server1.conf  --from-file&#x3D;server-second.conf&#x3D;.&#x2F;server2.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">2. 在Pod中引入配置文件为first.conf和second.conf</span><br><span class="line">~]# cat nginx-cm-pod.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-cm-pod</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">    tier: front</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: nginx-container</span><br><span class="line">    image: nginx:1.14-alpine</span><br><span class="line">    volumeMounts:</span><br><span class="line">      - name: service-conf</span><br><span class="line">        mountPath: &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;</span><br><span class="line">  volumes:</span><br><span class="line">  - name: service-conf</span><br><span class="line">    configMap:</span><br><span class="line">      name: nginx-cfg</span><br><span class="line">      items:</span><br><span class="line">      - key: server1.conf</span><br><span class="line">        path: first.conf</span><br><span class="line">      - key: server-second.conf  # 此处不再是server2.conf ，而是别名</span><br><span class="line">        path: second.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> ~]# kubectl  exec -it nginx-cm-pod -- ls &#x2F;etc&#x2F;nginx&#x2F;conf.d</span><br><span class="line">first.conf   second.conf</span><br></pre></td></tr></table></figure>



<h2 id="使用ConfigMap配置Redis"><a href="#使用ConfigMap配置Redis" class="headerlink" title="使用ConfigMap配置Redis"></a>使用ConfigMap配置Redis</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1. First create a kustomization.yaml containing a ConfigMap from the redis-config file:</span><br><span class="line">redis]# cat redis-config </span><br><span class="line">maxmemory 2mb</span><br><span class="line">maxmemory-policy allkeys-lru</span><br><span class="line"></span><br><span class="line">redis]#cat &lt;&lt;EOF &gt;.&#x2F;kustomization.yaml</span><br><span class="line">configMapGenerator:</span><br><span class="line">- name: example-redis-config</span><br><span class="line">  files:</span><br><span class="line">  - redis-config</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">2. Add the pod resource config to the kustomization.yaml:</span><br><span class="line">redis]# cat redis-pod.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: redis</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: redis</span><br><span class="line">    image: redis:5.0.4</span><br><span class="line">    command:</span><br><span class="line">      - redis-server</span><br><span class="line">      - &quot;&#x2F;redis-master&#x2F;redis.conf&quot;</span><br><span class="line">    env:</span><br><span class="line">    - name: MASTER</span><br><span class="line">      value: &quot;true&quot;</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 6379</span><br><span class="line">    resources:</span><br><span class="line">      limits:</span><br><span class="line">        cpu: &quot;0.1&quot;</span><br><span class="line">    volumeMounts:</span><br><span class="line">    - mountPath: &#x2F;redis-master-data</span><br><span class="line">      name: data</span><br><span class="line">    - mountPath: &#x2F;redis-master</span><br><span class="line">      name: config</span><br><span class="line">  volumes:</span><br><span class="line">    - name: data</span><br><span class="line">      emptyDir: &#123;&#125;</span><br><span class="line">    - name: config</span><br><span class="line">      configMap:</span><br><span class="line">        name: example-redis-config</span><br><span class="line">        items:</span><br><span class="line">        - key: redis-config</span><br><span class="line">          path: redis.conf</span><br><span class="line">          </span><br><span class="line">redis]# cat &lt;&lt;EOF &gt;&gt;.&#x2F;kustomization.yaml</span><br><span class="line">resources:</span><br><span class="line">- redis-pod.yaml</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">3. Apply the kustomization directory to create both the ConfigMap and Pod objects:</span><br><span class="line">edis]# kubectl apply -k .</span><br><span class="line"></span><br><span class="line">redis]# kubectl get -k .</span><br><span class="line">NAME                                        DATA   AGE</span><br><span class="line">configmap&#x2F;example-redis-config-dgh9dg555m   1      20s</span><br><span class="line"></span><br><span class="line">NAME        READY   STATUS              RESTARTS   AGE</span><br><span class="line">pod&#x2F;redis   0&#x2F;1     ContainerCreating   0          20s</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">4. Use kubectl exec to enter the pod and run the redis-cli tool to verify that the configuration was correctly applied:</span><br><span class="line">redis]# kubectl exec -it redis redis-cli   </span><br><span class="line">127.0.0.1:6379&gt; CONFIG GET maxmemory</span><br><span class="line">1) &quot;maxmemory&quot;</span><br><span class="line">2) &quot;2097152&quot;</span><br><span class="line">127.0.0.1:6379&gt; CONFIG GET maxmemory-policy</span><br><span class="line">1) &quot;maxmemory-policy&quot;</span><br><span class="line">2) &quot;allkeys-lru&quot;</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/29/Kuberntes%E5%AD%98%E5%82%A8%E4%B9%8BconfigMap/" data-id="ck8d4oxo600003u0l9tg1944c" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Ingress资源" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/29/Ingress%E8%B5%84%E6%BA%90/" class="article-date">
  <time datetime="2020-03-29T03:24:10.000Z" itemprop="datePublished">2020-03-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/29/Ingress%E8%B5%84%E6%BA%90/">Ingress资源</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Kubernetes 提供了两种负载均衡的机制用于发布公共服务，一种是工作在传输层的Service资源，一种是Ingress资源。前者只能实现”TCP负载均衡”，而无法实现 HTTPS 协议，而Ingress 的出现为我们提供了应用层HTTP(S)的访问能力。</p>
<p>Ingress 是 Kubernetes API 的标准类型资源，它是一组 基于DNS 名称或者 URL 路径把用户请求转发到指定的Service资源的规则，用于将集群外部的请求流量转发至集群内部完成服务发布。然而， Ingress 本身并不能进行流量转发，它仅仅是一组路由规则，如果想要真正的使这对规则生效，则需要先部署 Ingress 的控制器，Ingress 控制器能够监听某一个套接字，然后根据Ingress上的路由规则对用户的请求进行转发。</p>
<img src="../images/kubernetes/ingress.png" style="zoom:40%;" />

<h2 id="Ingress-Controller-部署"><a href="#Ingress-Controller-部署" class="headerlink" title="Ingress Controller 部署"></a>Ingress Controller 部署</h2><p>Ingress controller 可以由任何具有反向代理功能的服务程序实现，如Nginx、Envory、HaProxy和Traefik等。这里我们部署 ingree-nginx。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1. 前提准备</span><br><span class="line">ingress]# wget https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;kubernetes&#x2F;ingress-nginx&#x2F;nginx-0.30.0&#x2F;deploy&#x2F;static&#x2F;mandatory.yaml</span><br><span class="line">ingress]# sed -i &#39;s@quay.io@quay.azk8s.cn@g&#39;  mandatory.yaml</span><br><span class="line">ingress]# kubectl apply -f mandatory.yaml</span><br><span class="line">ingress]# kubectl  get pod -n ingress-nginx</span><br><span class="line">NAME                                        READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-ingress-controller-84bddb4478-99qb8   1&#x2F;1     Running   0          4m53s</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们也可以直接将 <code>mandatory.yaml</code>，修改成 DaemonSet 运行的方式，并且通过 nodeSelector 的方式，直接部署在具有公网ip地址的节点上，这样，我们就可以不用部署 Service 来接入流量了。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment # 修改为DaemonSet</span><br><span class="line">...</span><br><span class="line">spec:</span><br><span class="line"> #replicas: 1</span><br><span class="line">   nodeSelector:</span><br><span class="line">       matchLabels:</span><br><span class="line">           ingress: nginx</span><br></pre></td></tr></table></figure>

<h2 id="为-Ingress-nginx-控制器创建一个Service"><a href="#为-Ingress-nginx-控制器创建一个Service" class="headerlink" title="为 Ingress-nginx 控制器创建一个Service"></a>为 Ingress-nginx 控制器创建一个Service</h2><p>ingress-nginx 本身不能介入外部流量，所以我们需要为此控制器创建一个 Service 用来接入外部流量，此Service的类型为nodePort。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ingress]# wget https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;kubernetes&#x2F;ingress-nginx&#x2F;nginx-0.30.0&#x2F;deploy&#x2F;static&#x2F;provider&#x2F;baremetal&#x2F;service-nodeport.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ingress]# cat service-nodeport.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-nginx</span><br><span class="line">  namespace: ingress-nginx</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io&#x2F;name: ingress-nginx</span><br><span class="line">    app.kubernetes.io&#x2F;part-of: ingress-nginx</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - name: http</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 80  </span><br><span class="line">      nodePort: 30080 # 使用固定端口</span><br><span class="line">      protocol: TCP</span><br><span class="line">    - name: https</span><br><span class="line">      port: 443</span><br><span class="line">      targetPort: 443</span><br><span class="line">      nodePort: 30443 # 使用固定端口</span><br><span class="line">      protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io&#x2F;name: ingress-nginx</span><br><span class="line">    app.kubernetes.io&#x2F;part-of: ingress-nginx</span><br></pre></td></tr></table></figure>

<h2 id="创建两个-后段Service-用来演示Ingress-功能"><a href="#创建两个-后段Service-用来演示Ingress-功能" class="headerlink" title="创建两个 后段Service 用来演示Ingress 功能"></a>创建两个 后段Service 用来演示Ingress 功能</h2><p>这样我们的Ingress 就已经创建好了，下面我们创建两个后段服务器，用来演示Ingress-nginx的功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">ingress]# cat backend-v1.yaml</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: dep-backend-1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      version: myapp-v1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: myapp-v1-pod</span><br><span class="line">      labels:</span><br><span class="line">        version: myapp-v1</span><br><span class="line">    spec:    </span><br><span class="line">      containers:</span><br><span class="line">      - name: myapp-container</span><br><span class="line">        image: ikubernetes&#x2F;myapp:v1</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-svc-1</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    version: myapp-v1</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">ingress]# cat backend-v2.yaml</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: dep-backend-2</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      version: myapp-v2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: myapp-v1-pod</span><br><span class="line">      labels:</span><br><span class="line">        version: myapp-v2</span><br><span class="line">    spec:    </span><br><span class="line">      containers:</span><br><span class="line">      - name: myapp-container</span><br><span class="line">        image: ikubernetes&#x2F;myapp:v2</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-svc-2</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    version: myapp-v2</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br></pre></td></tr></table></figure>

<h2 id="Ingress-资源类型"><a href="#Ingress-资源类型" class="headerlink" title="Ingress 资源类型"></a>Ingress 资源类型</h2><h3 id="单Service资源型Ingress"><a href="#单Service资源型Ingress" class="headerlink" title="单Service资源型Ingress"></a>单Service资源型Ingress</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ingress]# cat single-ingress.yaml </span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: single-ingress</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io&#x2F;rewrite-target: &#x2F;</span><br><span class="line">    kubernetes.io&#x2F;ingress.class: &quot;nginx&quot;</span><br><span class="line">spec:</span><br><span class="line">   rules:</span><br><span class="line">   - host: www.myapp1.com       </span><br><span class="line">     http:</span><br><span class="line">       paths:</span><br><span class="line">       - path: &#x2F;</span><br><span class="line">         backend:</span><br><span class="line">           serviceName: myapp-svc-1 #  service 资源的名称</span><br><span class="line">           servicePort: 80          #  service 资源监听的端口</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ingress]# kubectl  get ingress -o wide</span><br><span class="line">NAME             HOSTS            ADDRESS         PORTS   AGE</span><br><span class="line">single-ingress   www.myapp1.com   10.107.217.61   80      13m</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">获取 ingress service 映射的nodeport</span><br><span class="line">ingress]# kubectl get services -n ingress-nginx</span><br><span class="line">NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span><br><span class="line">ingress-nginx   NodePort   10.107.217.61   &lt;none&gt;        80:30080&#x2F;TCP,443:30443&#x2F;TCP   16m</span><br></pre></td></tr></table></figure>

<img src="../images/kubernetes/single-ingress.png" style="zoom:40%;" />

<h3 id="基于主机名的虚拟主机"><a href="#基于主机名的虚拟主机" class="headerlink" title="基于主机名的虚拟主机"></a>基于主机名的虚拟主机</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">ingress]# cat  host-based-routing.yaml </span><br><span class="line">apiVersion: networking.k8s.io&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-myapp1</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io&#x2F;ingress.class: &quot;nginx&quot;</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: www.myapp1.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: myapp-svc-1</span><br><span class="line">          servicePort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-myapp2</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io&#x2F;ingress.class: &quot;nginx&quot;</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: www.myapp2.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: &#x2F;</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: myapp-svc-2</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure>

<img src="../images/kubernetes/base-host.png" style="zoom:40%;" />

<h3 id="TLS-为服务提供https协议访问"><a href="#TLS-为服务提供https协议访问" class="headerlink" title="TLS-为服务提供https协议访问"></a>TLS-为服务提供https协议访问</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 创建自签证书</span><br><span class="line">certs]#  openssl req -x509 -nodes -days 3650 -newkey rsa:2048 -keyout www.myapp1.com.key -out www.myapp1.com.crt -subj &quot;&#x2F;CN&#x3D;www.myapp1.com&#x2F;O&#x3D;www.myapp1.com&quot;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2. 将自签证书创建为集群内 tls 格式的secret</span><br><span class="line">certs]# kubectl create secret tls myapp1-secret --key www.myapp1.com.key --cert www.myapp1.com.crt</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">certs]# cat https-ingress.yaml </span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: https-ingress</span><br><span class="line">  annotations:</span><br><span class="line">    nginx.ingress.kubernetes.io&#x2F;rewrite-target: &#x2F;</span><br><span class="line">    kubernetes.io&#x2F;ingress.class: &quot;nginx&quot;</span><br><span class="line">spec:</span><br><span class="line">   tls:</span><br><span class="line">     - hosts:</span><br><span class="line">       -  www.myapp1.com</span><br><span class="line">       secretName: myapp1-secret</span><br><span class="line">   rules:</span><br><span class="line">   - host: www.myapp1.com</span><br><span class="line">     http:</span><br><span class="line">       paths:</span><br><span class="line">       - path: &#x2F;</span><br><span class="line">         backend:</span><br><span class="line">           serviceName: myapp-svc-1</span><br><span class="line">           servicePort: 80</span><br></pre></td></tr></table></figure>

<img src="../images/kubernetes/https.png" style="zoom:40%;" />

<h3 id="开启认证功能-Basic-Authentication"><a href="#开启认证功能-Basic-Authentication" class="headerlink" title="开启认证功能(Basic Authentication)"></a>开启认证功能(Basic Authentication)</h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/29/Ingress%E8%B5%84%E6%BA%90/" data-id="ck8chkhjt0000ez0l7sb23b51" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ingress/" rel="tag">ingress</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Service-资源详解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/28/Service-%E8%B5%84%E6%BA%90%E8%AF%A6%E8%A7%A3/" class="article-date">
  <time datetime="2020-03-28T10:01:53.000Z" itemprop="datePublished">2020-03-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/28/Service-%E8%B5%84%E6%BA%90%E8%AF%A6%E8%A7%A3/">Service 资源详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Service-资源详解"><a href="#Service-资源详解" class="headerlink" title="Service 资源详解"></a>Service 资源详解</h1><p>在 Kubernetes 集群中，Pod随时都有可能被控制器新建或迁移，那么其上的IP也会发生变动，这种动态性没法给用户提供一个固定访问问口地址给用户，为了解决这类问题，Kubernetes引入了Service的概念。Service 为用户提供了一个固定的访问入口。我们可以通过标签关联后段的Pod，这样当后段的Pod发生变动时，新建立的Pod会自动关联到我们的Service上，这就是所谓的自动发现。</p>
<img src="../images/kubernetes/service1.png" style="zoom:50%;" />

<h2 id="Service代理模式分类"><a href="#Service代理模式分类" class="headerlink" title="Service代理模式分类"></a>Service代理模式分类</h2><p>Kubernetes 集群中，每个Node 都运行一个 kube-proxy 进程，kube-proxy 负责为 Service 实现一种 虚拟IP(VIP)的形式，而不是ExterName的形式。在Kubernetes v1.0的版本，代理完全是在 userspace，在Kubernetes v1.1 版本，新增加iptables代理，但并不是默认模式。从Kubernetes v1.2起，默认就是iptables模式代理，在Kubernetes v1.8.0-beta.0 中，默认添加了ipvs 代理，在Kubernetes v1.14 版本中，默认使用了 ipvs 代理。</p>
<ul>
<li><strong>UserSpace</strong> 用户空间模式</li>
</ul>
<p>对于每个Service对象，kube-proxy会随机打开一个本地端口，任何到达此代理端口的请求都会被SNAT转发至当前Service对象后段的Pod对象，默认的调度算法是 <code>round-robin</code>。</p>
<img src="../images/kubernetes/userspace.png" style="zoom:30%;" />

<ul>
<li><strong>iptables代理模式</strong></li>
</ul>
<p>对于每个Service对象，kube-proxy会创建iptables规则直接捕获到达ClusterIp和Port的流量，并重定向至当前Service所关联的后段Pod对象。对于userspace模式来说，iptables不再将流量在用户空间和内核空间来回切换，因此也就更为高效和可靠。</p>
<img src="../images/kubernetes/iptables.png" style="zoom:30%;" />

<ul>
<li><strong>ipvs代理模式</strong></li>
</ul>
<p>与iptables代理模式不同之处在于，用户群请求的流量调度直接由ipvs实现，ipvs构建在netfilter的钩子函数上，使用hash表座位底层数据结构并工作在内核空间，所以相对iptables来说它具有流量转发速度快，规则同步性能好的特性。ipvs支持更多的算法，例如：rr、lc、dh、、sed、nq等</p>
<img src="../images/kubernetes/ipvs.png" style="zoom:30%;" />

<h2 id="Service-类型"><a href="#Service-类型" class="headerlink" title="Service 类型"></a>Service 类型</h2><ul>
<li><strong>ClusterIP</strong>：默认类型，仅用于Kubernetes集群内部访问</li>
</ul>
<p>示例：假设我们有一组Pod ，每个Pod都侦听TCP端口80并带有标签<code>app=MyApp</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">~]# cat myapp-svc.yaml</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: example-dep</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: MyApp</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: MyApp</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: myapp-container</span><br><span class="line">        image: ikubernetes&#x2F;myapp:v1</span><br><span class="line">        ports:</span><br><span class="line">          - name: http</span><br><span class="line">            containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-svc-clusterip</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">   selector:</span><br><span class="line">     app: MyApp</span><br><span class="line">   ports:</span><br><span class="line">   - name: http</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 80</span><br><span class="line">     targetPort: 80</span><br><span class="line">   type: ClusterIP</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">2. 多端口代理模式</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-service-clusterip</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: MyApp</span><br><span class="line">  ports:</span><br><span class="line">    - name: http</span><br><span class="line">      protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 9376</span><br><span class="line">    - name: https</span><br><span class="line">      protocol: TCP</span><br><span class="line">      port: 443</span><br><span class="line">      targetPort: 9377</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>NodePort</strong>：在 ClusterIP的基础上，在每个Node节点上绑定一个端口，这种方式可以通过<code>IP+Port</code>的方式接入外部流量</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~]# vim myapp-svc-nodeport.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-svc-nodeport</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">   selector:</span><br><span class="line">     app: MyApp</span><br><span class="line">   ports:</span><br><span class="line">   - name: http</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 80</span><br><span class="line">     nodePort: 30080</span><br><span class="line">     targetPort: 80</span><br><span class="line">   type: NodePort</span><br></pre></td></tr></table></figure>

<ul>
<li>Headless：有时我们需要或者不想要负载均衡以及单独的Service IP。遇到这种情况，我们可以指定ClusterIP的值为None来创建HeadlessService,这样解析出来地址是则为后段所有Pod的IP地址。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~]# vim myapp-svc-headless.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-svc-headless</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">   clusterIP: None</span><br><span class="line">   selector:</span><br><span class="line">     app: MyApp</span><br><span class="line">   ports:</span><br><span class="line">   - name: http</span><br><span class="line">     protocol: TCP</span><br><span class="line">     port: 80</span><br><span class="line">     targetPort: 80</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> ~]# dig -t A myapp-svc-headless.default.svc.cluster.local. @10.244.0.6</span><br><span class="line"> ;; ANSWER SECTION:</span><br><span class="line">myapp-svc-headless.default.svc.cluster.local. 30 IN A 10.244.1.43</span><br><span class="line">myapp-svc-headless.default.svc.cluster.local. 30 IN A 10.244.3.44</span><br><span class="line">myapp-svc-headless.default.svc.cluster.local. 30 IN A 10.244.2.29</span><br><span class="line">~]# kubectl  get pod  -o wide</span><br><span class="line">NAME                           READY   STATUS    RESTARTS   AGE   IP            NODE             NOMINATED NODE   READINESS GATES</span><br><span class="line">example-dep-6dc749d854-kvtqg   1&#x2F;1     Running   0          25m   10.244.3.44   node3.linux.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">example-dep-6dc749d854-n2tqq   1&#x2F;1     Running   0          25m   10.244.1.43   node1.linux.io   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">example-dep-6dc749d854-ncpst   1&#x2F;1     Running   0          25m   10.244.2.29   node2.linux.io   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>LoadBalancer：在NodePort的基础上借助一个cloud provider创建一个外部的负载均衡器，并将请求转发到NodePort</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-service</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: MyApp</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 9376</span><br><span class="line">  clusterIP: 10.0.171.239</span><br><span class="line">  type: LoadBalancer</span><br><span class="line">status:</span><br><span class="line">  loadBalancer:</span><br><span class="line">    ingress:</span><br><span class="line">    - ip: 192.0.2.127 #此为外部SLB地址</span><br></pre></td></tr></table></figure>

<ul>
<li>ExternalName：把集群外部的流量直接引入到集群内部直接使用，没有任何代理被创建。只有Kubernetes 1.7+的版本或者高版本kube-dns才支持</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-service</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: MyApp</span><br><span class="line">  ports:</span><br><span class="line">    - name: http</span><br><span class="line">      protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 9376</span><br><span class="line">  externalIPs:</span><br><span class="line">    - 80.11.12.10</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/28/Service-%E8%B5%84%E6%BA%90%E8%AF%A6%E8%A7%A3/" data-id="ck8bpmtgc0000c60l1hgscqb9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/" rel="tag">kubernetes</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Pod-Controllers-详解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/27/Pod-Controllers-%E8%AF%A6%E8%A7%A3/" class="article-date">
  <time datetime="2020-03-27T09:50:51.000Z" itemprop="datePublished">2020-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/27/Pod-Controllers-%E8%AF%A6%E8%A7%A3/">Pod Controllers 详解</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Pod-Contrallers-详解"><a href="#Pod-Contrallers-详解" class="headerlink" title="#Pod Contrallers 详解"></a>#Pod Contrallers 详解</h2><p>Kubernetes 集群中，所有的Pod都是都会跟着环境的变化，而发生变化，可能某个磁盘出现问题，又或者某个节点出现问题，那么其上的 Pod 就需要发生变动，而这些变动需要通过一种叫控制器的对象来控制，这些对象会时时刻刻通过监控Api-Server 共享的状态，将集群中的变动稳定在用户所期望的状态。</p>
<img src="../images/kubernetes/controller.png" style="zoom:50%;" />

<h2 id="ReplicaSet"><a href="#ReplicaSet" class="headerlink" title="ReplicaSet"></a>ReplicaSet</h2><p>ReplicaSet的目的是维护在任何时间段运行的稳定的Pod数量。因此，它通常用于保证指定数量的相同Pod的可用性。其编排文件中必须的几个字段包括：<code>apiVersion</code>、<code>kind</code>、<code>metadata</code>、<code>spec</code>以及<code>spec.replicas</code>、<code>spec.template</code>、<code>spec.selector</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~]# cat replicaset.yaml </span><br><span class="line">apiVersion: extensions&#x2F;v1beta1</span><br><span class="line">kind: ReplicaSet</span><br><span class="line">metadata:</span><br><span class="line">  name: replicaset-demo</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: myapp</span><br><span class="line">      version: v1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: replicaset-pod</span><br><span class="line">      namespace: default</span><br><span class="line">      labels:</span><br><span class="line">        app: myapp</span><br><span class="line">        version: v1</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: replicaset-containe</span><br><span class="line">        image: myapp:v1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 列出 rs： kubectl get rs</span><br><span class="line">2. 删除 rs： kubectl delete rs&#x2F;replicaset-demo</span><br></pre></td></tr></table></figure>



<h2 id="Deployments"><a href="#Deployments" class="headerlink" title="Deployments"></a>Deployments</h2><p>管ReplicaSet可以单独使用，但是如今推荐使用Deployments做为Pod编排的（新建、删除、更新）的主要方式。Deploymnets是更高一级的抽象，提供了RS的管理功能。</p>
<img src="../images/kubernetes/ds.png" style="zoom: 25%;" />

<p>Deployment实际上是对RS和Pod的管理，它总先是创建RS，由RS创建Pods。由Deployment创建的RS的命名规则为<code>[DEPLOYMENT-NAME]-[POD-TEMPLATE-HASH-VALUE]</code>，建议不要手工维护Deployment创建的RS。Deployment的更新仅在Pod的template发生更新的情况下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">~]# vim deployment-demo.yaml </span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: deployment-demo</span><br><span class="line">  namespace: default </span><br><span class="line">  labels:</span><br><span class="line">    app: front</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: front</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: myapp-ds-pod</span><br><span class="line">      labels:</span><br><span class="line">        app: front</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: myapp-container</span><br><span class="line">        image: myapp:v1</span><br></pre></td></tr></table></figure>

<ul>
<li>创建Deployment</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl  apply -f deployment-demo.yaml</span><br></pre></td></tr></table></figure>

<ul>
<li>更新Deployment</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl  set image deployment&#x2F;deployment-demo myapp-container&#x3D;ikubernetes&#x2F;myapp:v2</span><br></pre></td></tr></table></figure>

<ul>
<li>回滚可以使用命令行，也可以修稿资源清单文件。默认回滚记录10个版本，可以通过<code>.spec.revisionHistoryLimit</code>修改。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl rollout undo  deployment deployment-demo </span><br><span class="line">~]# kubectl  rollout undo --to-revision&#x3D;3 deployment deployment-demo # 回滚到指定版本</span><br></pre></td></tr></table></figure>

<ul>
<li>扩容</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl scale deployment&#x2F;deployment-demo --replicas&#x3D;5 </span><br><span class="line">如果集群打开了自动扩容功能，还可以设置自动扩容的条件:</span><br><span class="line">~]# kubectl autoscale deployment&#x2F;deployment-demo--min&#x3D;10 --max&#x3D;15 --cpu-percent&#x3D;80</span><br></pre></td></tr></table></figure>

<ul>
<li>暂停部署过程</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl rollout pause deployment&#x2F;nginx-deployment</span><br><span class="line">~]# kubectl rollout resume deployment&#x2F;nginx-deployment</span><br></pre></td></tr></table></figure>

<ul>
<li>更新策略<ul>
<li><code>trategy .spec.strategy</code>：Recreate和RollingUpdate<ul>
<li>Recreate:：策略为先杀死旧Pods再创建新Pods，</li>
<li>RollingUpdate：一边创建新Pods，一边杀掉旧Pods.</li>
</ul>
</li>
<li><code>Max Unavailable .spec.strategy.rollingUpdate.maxUnavailable</code>：更新过程中允许不可用Pods的最大比率，默认为25%</li>
<li><code>Max Surge .spec.strategy.rollingUpdate.maxSurge</code>：更新过程中允许超过replicas的最大Pods数量，默认为25%</li>
<li><code>Progress Deadline Seconds .spec.progressDeadlineSeconds</code> ：可选参数，设置系统报告进展的时间</li>
<li><code>Min Ready Seconds .spec.minReadySeconds</code>：可选参数，设置新建Pod能正常运行的最小时间间隔</li>
<li><code>Revision History Limit .spec.revisionHistoryLimit</code> 可选参数，设置历史记录数量</li>
</ul>
</li>
</ul>
<h2 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h2><p>使用Kubernetes来调度无状态的应用非常简单，StatefulSets 用来部署有状态的服务。<a href="https://www.baidu.com" target="_blank" rel="noopener">详情请点接这里</a></p>
<h2 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h2><p>DaemonSet确保所有的Node上都运行了一份Pod的副本，只要Node加入到集群中，Pod就会在Node上创建。典型的应用场景包括：运行一个存储集群（glusterd,ceph）、运行一个日志收集集群（fluentd,logstash）、运行监控程序（Prometheus Node Exporter,collectd,Datadog等）。默认情况下DaemonSet由DaemonSet控制器调度，如果设置了<code>nodeAffinity</code>参数，则会有默认的scheduler调度。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">controllers&#x2F;daemonset.yaml </span><br><span class="line"></span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: fluentd-elasticsearch</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: fluentd-logging</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: fluentd-elasticsearch</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: fluentd-elasticsearch</span><br><span class="line">    spec:</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: node-role.kubernetes.io&#x2F;master</span><br><span class="line">        effect: NoSchedule</span><br><span class="line">      containers:</span><br><span class="line">      - name: fluentd-elasticsearch</span><br><span class="line">        image: quay.io&#x2F;fluentd_elasticsearch&#x2F;fluentd:v2.5.2</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: 200Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 200Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: varlog</span><br><span class="line">          mountPath: &#x2F;var&#x2F;log</span><br><span class="line">        - name: varlibdockercontainers</span><br><span class="line">          mountPath: &#x2F;var&#x2F;lib&#x2F;docker&#x2F;containers</span><br><span class="line">          readOnly: true</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: varlog</span><br><span class="line">        hostPath:</span><br><span class="line">          path: &#x2F;var&#x2F;log</span><br><span class="line">      - name: varlibdockercontainers</span><br><span class="line">        hostPath:</span><br><span class="line">          path: &#x2F;var&#x2F;lib&#x2F;docker&#x2F;containers</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl  get daemonset -n kube-system -w</span><br></pre></td></tr></table></figure>

<blockquote>
<p>我们可以给特定的主机节点打<code>label</code>运行特定的守护进程</p>
</blockquote>
<h2 id="Jobs"><a href="#Jobs" class="headerlink" title="Jobs"></a>Jobs</h2><p>Job通过创建一个或多个Pod来运行特定的任务，当正常完成任务的Pod数量达到设定标准时，Job就会结束。删除Job会将Job创建的所有Pods删除</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: batch&#x2F;v1</span><br><span class="line">kind: Job</span><br><span class="line">metadata:</span><br><span class="line">  name: pi</span><br><span class="line">spec:</span><br><span class="line">  completions: 5 # 指定任务执行次数，顺序执行</span><br><span class="line">  parallelism: 2 # 指定并行任务的数量</span><br><span class="line">  backoffLimit: 4 # 允许任务失败的次数</span><br><span class="line">  activeDeadlineSeconds: 100    # 允许任务执行的最长时间</span><br><span class="line">  template:</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: pi</span><br><span class="line">        image: docker.io&#x2F;perl</span><br><span class="line">        command: [&quot;perl&quot;, &quot;-Mbignum&#x3D;bpi&quot;, &quot;-wle&quot;, &quot;print bpid(2000)&quot;]</span><br><span class="line">      restartPolicy: Never</span><br></pre></td></tr></table></figure>

<ul>
<li>非并行的Job，通常只启动一个Pod执行任务</li>
<li>带有固定完成数量的并行Job，需要将<code>.spec.completions</code>设置为非零值</li>
<li>与队列结合的并行Job，不需要设置<code>.spec.completions</code>，设置<code>.spec.parallelism</code></li>
</ul>
<blockquote>
<p>Kubernetes提供的并行Job并不适合科学计算或者执行相关的任务，更适合执行邮件发送、渲染、文件转义等等单独的任务</p>
</blockquote>
<h2 id="CronJob"><a href="#CronJob" class="headerlink" title="CronJob"></a>CronJob</h2><p>Cron Job是根据时间来自动创建Job对象。类似于Crontab，周期性的执行一个任务。每次执行期间，会创建一个Job对象。也可能会创建两个或者不创建Job，这个情况可能会发生，因此应该保证Job是幂等的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: batch&#x2F;v1beta1</span><br><span class="line">kind: CronJob</span><br><span class="line">metadata:</span><br><span class="line">  name: hello</span><br><span class="line">spec:</span><br><span class="line">  schedule: &quot;*&#x2F;1 * * * *&quot;</span><br><span class="line">  jobTemplate:</span><br><span class="line">    spec:</span><br><span class="line">      template:</span><br><span class="line">        spec:</span><br><span class="line">          containers:</span><br><span class="line">          - name: hello</span><br><span class="line">            image: docker.io&#x2F;busybox</span><br><span class="line">            args:</span><br><span class="line">            - &#x2F;bin&#x2F;sh</span><br><span class="line">            - -c</span><br><span class="line">            - date; echo Hello from the Kubernetes cluster</span><br><span class="line">          restartPolicy: OnFailure</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/27/Pod-Controllers-%E8%AF%A6%E8%A7%A3/" data-id="ck8a6qy7e00002x0l0z4kal52" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/" rel="tag">kubernetes</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Working-with-Pods" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/27/Working-with-Pods/" class="article-date">
  <time datetime="2020-03-27T06:36:18.000Z" itemprop="datePublished">2020-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/27/Working-with-Pods/">Working with Pods</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Pod-介绍"><a href="#Pod-介绍" class="headerlink" title="Pod 介绍"></a><a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/" target="_blank" rel="noopener">Pod 介绍</a></h1><p>Pod 是Kuberntes 集群中最小的运行/部署单元。它是一个或一组关系紧密的容器的集合。Pod 中的容器会自动位于同一个集群中的物理机或虚拟机上，他们共享Process ID (PID) 、<br> Network namespace、 Interprocess Communication (IPC) namespace、Unix Time Sharing (UTS) namespace等资源。</p>
<img src="../images/kubernetes/pod1.png" style="zoom:33%;" />

<h2 id="Pod-的种类"><a href="#Pod-的种类" class="headerlink" title="Pod 的种类"></a>Pod 的种类</h2><p>Pod并不提供保证正常运行的能力，因为可能遭受Node节点的物理故障、网络分区等等的影响，整体的高可用是Kubernetes集群通过在集群内调度Node来实现的。通常情况下我们不要直接创建Pod，一般都是通过Controller来进行管理，但是了解Pod对于我们熟悉控制器非常有好处。</p>
<ul>
<li><strong>静态Pod</strong></li>
</ul>
<p>Pod由我们手写配置文件yaml创建出来的独立的Pod，其状态不会不存放在Kubernetes的etcd存储里，而是存放在某个具体的Node上的文件中，并且只在此Node上启动运行。当kubelete 重启后,此 Pod 不会被自动创建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-pod</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myapp-container</span><br><span class="line">    image: busybox</span><br><span class="line">    command: [&#39;sh&#39;, &#39;-c&#39;, &#39;echo Hello Kubernetes! &amp;&amp; sleep 3600&#39;]</span><br></pre></td></tr></table></figure>



<ul>
<li><strong>动态Pod</strong></li>
</ul>
<p>动态Pod一旦被创建，其状态就会被放入到<code>etcd</code>中存储，随后会被Kubernetes Master调度到某个具体的Node上并进行绑定<code>(Binding)</code>,随后该Pod 被对应的Node上的kubelet进程实例化成一组相关的docker容器运行起来。   当Pod里的某个容器停止时，Kubernetes会自动检测到这个问题并且重新启动这个Pod (重启Pod里的所有容器)，如果Pod所在的Node宕机，则会将这个Node上所偶的Pod从新调度到其他节点上。我们使用 ReplicaSet、Deployment控制器 管理的Pod就是此类Pod</p>
<h2 id="Pod-的基本语法"><a href="#Pod-的基本语法" class="headerlink" title="Pod 的基本语法"></a>Pod 的基本语法</h2><p>Pod的配置信息中有几个重要部分，apiVersion、kind、metadata、spec以及status。其中<code>apiVersion</code>和<code>kind</code>是比较固定的，<code>status</code>是运行时的状态，所以最重要的就是<code>metadata</code>和<code>spec</code>两个部分。在编写配置文件时，可以通过<a href="https://kubernetes.io/docs/reference/" target="_blank" rel="noopener">API Reference</a>来参考，也可以通过命令<code>kubectl explain pod</code>查看</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: demo-ports-pod</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp</span><br><span class="line">    fier: frontend</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myapp-container</span><br><span class="line">    image: ikubernetes&#x2F;myapp:v1</span><br><span class="line">    ports:</span><br><span class="line">    - name: http</span><br><span class="line">      containerPort: 80</span><br><span class="line">    - name: https</span><br><span class="line">      containerPort: 443</span><br><span class="line">  - name: busybox</span><br><span class="line">    image: busybox:latest</span><br><span class="line">    command: [&quot;&#x2F;bin&#x2F;sh&quot;, &quot;-c&quot;, &quot;sleep 3600&quot;]</span><br></pre></td></tr></table></figure>

<h2 id="Pod-的管理"><a href="#Pod-的管理" class="headerlink" title="Pod 的管理"></a>Pod 的管理</h2><ul>
<li><p>了解一个正在运行的Pod的配置：<code>kubectl get pod demo-ports-pod -o yaml</code></p>
</li>
<li><p>可以查看命令行标准输出的日志：<code>kubectl logs demo-ports-pod [-c contariner-name]</code> </p>
</li>
</ul>
<h2 id="标签管理"><a href="#标签管理" class="headerlink" title="标签管理"></a>标签管理</h2><p>标签是Kubernetes管理Pod的重要依据，我们可以在Pod yaml文件中 metadata 中指定，也可以通过命令行进行管理。</p>
<img src=" ../images/kubernetes/labels.png" style="zoom:50%;" />

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">版本标签：release：stable、release：canary、release、beta</span><br><span class="line">环境标签：environment：dev、environment：qa、environment：production</span><br><span class="line">应用标签：app：ui、app：as、app：sc</span><br><span class="line">架构层级标签：tier：frontend、tier：backend、tier：cache</span><br><span class="line">分区标签：partition：customerA、partition：customerB</span><br><span class="line">品控级别标签：track：daily、track：weekly</span><br></pre></td></tr></table></figure>

<ul>
<li><p>显示Pod的标签：<code>kubectl get pods --show-labels</code></p>
</li>
<li><p>根据标签来查询Pod：<code>kubectl get pods -l app=myapp --show-labels</code></p>
</li>
<li><p>增加标签：<code>kubectl label pod myapp-pod version=v1</code></p>
</li>
<li><p>修改标签：<code>kubectl label pod myapp-pod version=v2 --overwrite</code></p>
</li>
<li><p>根据标签选择器删除Pod：<code>kubectl  delete pod -l version=v1</code></p>
</li>
</ul>
<h2 id="Pod的生命周期"><a href="#Pod的生命周期" class="headerlink" title="Pod的生命周期"></a>Pod的生命周期</h2><p>在一个pod中,可以运行多个容器,但通常在一个pod里面运行一个容器,容器在创建之前,有多个初始化容器(init container)用来进行初始化环境,init container执行完,它就退出了,接下来是主容器(main container)开始启动,主容器启动时也要初始化主容器里面的环境,在主容器刚启动时,用户可以手动嵌入一个操作叫post start;在主容器结束前,也可以做一个收尾操作pre stop,用来在主容器结束前做一个清理。</p>
<p><img src="../images/kubernetes/kuberetes-live.png" alt=""></p>
<table>
<thead>
<tr>
<th align="left">值</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>Pending</code></td>
<td align="left">该Pod已被Kubernetes系统接受，但是尚未创建一个或多个Container映像。这包括计划之前的时间以及通过网络下载图像所花费的时间，这可能需要一段时间。</td>
</tr>
<tr>
<td align="left"><code>Running</code></td>
<td align="left">Pod已绑定到一个节点，并且所有容器都已创建。至少一个容器仍在运行，或者正在启动或重新启动。</td>
</tr>
<tr>
<td align="left"><code>Succeeded</code></td>
<td align="left">Pod中的所有容器已成功终止，并且不会重新启动。</td>
</tr>
<tr>
<td align="left"><code>Failed</code></td>
<td align="left">Pod中的所有容器都已终止，并且至少一个容器因故障而终止。也就是说，容器要么以非零状态退出，要么被系统终止。</td>
</tr>
<tr>
<td align="left"><code>Unknown</code></td>
<td align="left">由于某种原因，通常由于与Pod主机通信时出错而无法获得Pod的状态。</td>
</tr>
</tbody></table>
<p>Pod生命周期中的重要行为:初始化容器、容器探测</p>
<ul>
<li><strong><a href="https://kubernetes.io/docs/concepts/workloads/pods/init-containers/" target="_blank" rel="noopener">初始化容器</a></strong></li>
</ul>
<p>负责初始化工作，在它没有运行完成之前pod一定处于未就绪状态(unready)，所以readiness类型探针一定会诊断失败</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: myapp-pod</span><br><span class="line">  labels:</span><br><span class="line">    app: myapp</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: myapp-container</span><br><span class="line">    image: busybox:1.28</span><br><span class="line">    command: [&#39;sh&#39;, &#39;-c&#39;, &#39;echo The app is running! &amp;&amp; sleep 3600&#39;]</span><br><span class="line">  initContainers:</span><br><span class="line">  - name: init-myservice</span><br><span class="line">    image: busybox:1.28</span><br><span class="line">    command: [&#39;sh&#39;, &#39;-c&#39;, &quot;until nslookup myservice.$(cat &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount&#x2F;namespace).svc.cluster.local; do echo waiting for myservice; sleep 2; done&quot;]</span><br><span class="line">  - name: init-mydb</span><br><span class="line">    image: busybox:1.28</span><br><span class="line">    command: [&#39;sh&#39;, &#39;-c&#39;, &quot;until nslookup mydb.$(cat &#x2F;var&#x2F;run&#x2F;secrets&#x2F;kubernetes.io&#x2F;serviceaccount&#x2F;namespace).svc.cluster.local; do echo waiting for mydb; sleep 2; done&quot;]</span><br></pre></td></tr></table></figure>



<ul>
<li><strong>容器探测</strong></li>
</ul>
<p>容器探测分为<code>liveness probe</code>存活性探测,用于判定主容器是否处于存活状态;<code>readiness probe</code>就绪性探测用于判定容器中的主进程是否准备就绪以及能否对外提供服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1. ExecAction：：在Container中执行指定的命令。如果命令以状态代码0退出，则认为诊断成功</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: liveness-exec-pod</span><br><span class="line">  namespace: prod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: liveness-exec-container</span><br><span class="line">    image: busybox:latest</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    command: [&quot;&#x2F;bin&#x2F;sh&quot;, &quot;-c&quot;, &quot;touch &#x2F;tmp&#x2F;healthy;sleep 30; rm -r &#x2F;tmp&#x2F;healthy;sleep 3600&quot;]</span><br><span class="line">    livenessProbe:</span><br><span class="line">      exec:</span><br><span class="line">        command: [&quot;test&quot;, &quot;-e&quot;, &quot;&#x2F;tmp&#x2F;healthy&quot;]</span><br><span class="line">      initialDelaySeconds: 2</span><br><span class="line">      periodSeconds: 3</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2. TCPSocketAction：对指定端口上的容器的IP地址执行TCP检查。如果端口打开，则认为诊断成功。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">3. HTTPGetAction：对指定端口和路径上容器的IP地址执行HTTP Get请求。如果响应的状态码大于或等于200且小于400，则认为诊断成功。</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    test: liveness</span><br><span class="line">  name: liveness-http</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - args:</span><br><span class="line">    - &#x2F;server</span><br><span class="line">    image: k8s.gcr.io&#x2F;liveness</span><br><span class="line">    livenessProbe:</span><br><span class="line">      httpGet:</span><br><span class="line">        path: &#x2F;healthz</span><br><span class="line">        port: 8080</span><br><span class="line">        httpHeaders:</span><br><span class="line">        - name: X-Custom-Header</span><br><span class="line">          value: Awesome</span><br><span class="line">      initialDelaySeconds: 15</span><br><span class="line">      timeoutSeconds: 1</span><br><span class="line">    name: liveness</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/27/Working-with-Pods/" data-id="ck89zhi470000p20lhevt2f8m" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pod/" rel="tag">Pod</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Hexo-博客搭建" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/27/Hexo-%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/" class="article-date">
  <time datetime="2020-03-27T06:18:03.000Z" itemprop="datePublished">2020-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/27/Hexo-%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/">Hexo 博客搭建</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ul>
<li>Github账号注册及仓库创建</li>
</ul>
<p><img src="../images/hexo/hexo.png" alt=""></p>
<blockquote>
<p>仓库名必须为：<code>username.github.io</code></p>
</blockquote>
<h4 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h4><ol>
<li>安装git：</li>
<li>安装node：<code>https://nodejs.org/en</code></li>
<li>安装 hexo：<code>sudo npm install -g hexo-cli</code></li>
<li>安装hexo-deployer-git 插件：<code>npm install hexo-deployer-git --save</code></li>
<li>初始化博客框架:<code>cd ~/Documents/HexoBlog &amp;&amp; hexo init</code></li>
<li>启动 hexo： <code>hexo -s</code></li>
</ol>
<h4 id="博客关联到Github仓库，编辑-config-yml文件"><a href="#博客关联到Github仓库，编辑-config-yml文件" class="headerlink" title="博客关联到Github仓库，编辑_config.yml文件"></a>博客关联到Github仓库，编辑<code>_config.yml</code>文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">type: git</span><br><span class="line">repo: https:&#x2F;&#x2F;github.com&#x2F;ops-k8s&#x2F;ops-k8s.github.io.git</span><br><span class="line">branch: master</span><br></pre></td></tr></table></figure>

<ul>
<li>推送到远程 github</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo g</span><br><span class="line"></span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure>

<ul>
<li>访问：<code>https://ops-k8s.github.io/</code></li>
</ul>
<h4 id="Hexo博客美化及功能增添"><a href="#Hexo博客美化及功能增添" class="headerlink" title="Hexo博客美化及功能增添"></a>Hexo博客美化及功能增添</h4><ol>
<li>选主题：<code>https://hexo.io/themes/</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~&#x2F;Documents&#x2F;HexoBlog</span><br><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;TriDiamond&#x2F;hexo-theme-obsidian.git themes&#x2F;obsidian</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ref: <a href="https://github.com/TriDiamond/hexo-theme-obsidian" target="_blank" rel="noopener">https://github.com/TriDiamond/hexo-theme-obsidian</a></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim _config.yaml</span><br><span class="line"></span><br><span class="line">theme: obsidian</span><br></pre></td></tr></table></figure>

<p><a href="https://www.jianshu.com/p/77db3862595c" target="_blank" rel="noopener">https://www.jianshu.com/p/77db3862595c</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/27/Hexo-%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/" data-id="ck89t3nqq0000fj0l4c9c1o2b" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Kubernetes-Addons-of-Dashboard" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/27/Kubernetes-Addons-of-Dashboard/" class="article-date">
  <time datetime="2020-03-27T05:32:42.000Z" itemprop="datePublished">2020-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/27/Kubernetes-Addons-of-Dashboard/">Kubernetes Addons of Dashboard</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Kubernetes-Addons-of-Dashboard"><a href="#Kubernetes-Addons-of-Dashboard" class="headerlink" title="Kubernetes Addons of Dashboard"></a><a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" target="_blank" rel="noopener">Kubernetes Addons of Dashboard</a></h1><p>仪表板是基于Web的Kubernetes用户界面。我们可以使用仪表板将容器化的应用程序部署到Kubernetes集群，对容器化的应用程序进行故障排除以及管理集群资源。也可以使用Dashboard来概述集群上运行的应用程序，以及创建或修改单个Kubernetes资源（例如Deployments，Jobs，DaemonSets等）。例如，使用部署向导来扩展部署，启动滚动更新，重新启动Pod或部署新应用程序。</p>
<h2 id="拉去资源配置清单"><a href="#拉去资源配置清单" class="headerlink" title="拉去资源配置清单"></a>拉去资源配置清单</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dashboard]# wget  https:&#x2F;&#x2F;raw.githubusercontent.com&#x2F;kubernetes&#x2F;dashboard&#x2F;v2.0.0-beta8&#x2F;aio&#x2F;deploy&#x2F;recommended.yaml</span><br></pre></td></tr></table></figure>

<h2 id="应用配置清单文件"><a href="#应用配置清单文件" class="headerlink" title="应用配置清单文件"></a>应用配置清单文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dashboard]# kubectl  apply -f recommended.yaml</span><br></pre></td></tr></table></figure>

<h2 id="暴露-DashBoard"><a href="#暴露-DashBoard" class="headerlink" title="暴露 DashBoard"></a>暴露 DashBoard</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dashboard]# kubectl patch svc kubernetes-dashboard -p &#39;&#123;&quot;spec&quot;:&#123;&quot;type&quot;: &quot;NodePort&quot;&#125;&#125;&#39; -n kubernetes-dashboard</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dashboard]# kubectl get svc -n kubernetes-dashboard</span><br><span class="line">NAME                        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">dashboard-metrics-scraper   ClusterIP   10.98.157.144   &lt;none&gt;        8000&#x2F;TCP        2m32s</span><br><span class="line">kubernetes-dashboard        NodePort    10.99.12.157    &lt;none&gt;        443:32256&#x2F;TCP   2m32s</span><br></pre></td></tr></table></figure>

<h2 id="登陆-Dashboard"><a href="#登陆-Dashboard" class="headerlink" title="登陆 Dashboard"></a>登陆 Dashboard</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1. 使用Kubernetes的服务帐户机制创建新用户，授予此用户管理权限，并使用绑定到此用户的承载令牌登录仪表板</span><br><span class="line">dashboard]$ vim dashboard-admuser.yaml</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line">  </span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">dashboard]$ kubectl  apply -f  dashboard-admuser.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2. 获取Token</span><br><span class="line">dashboard]$ kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk &#39;&#123;print $1&#125;&#39;)</span><br></pre></td></tr></table></figure>

<p><img src="../images/kubernetes/kubernetes-dashboard.png" alt=""></p>
<h2 id="设置用户密码登陆"><a href="#设置用户密码登陆" class="headerlink" title="设置用户密码登陆"></a>设置用户密码登陆</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 创建文件（用户密码文件</span><br><span class="line">~]# vim &#x2F;etc&#x2F;kubernetes&#x2F;basic_auth_file</span><br><span class="line">admin,admin,1 # 数字id，不允许重复</span><br><span class="line">tom,tom,2</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/27/Kubernetes-Addons-of-Dashboard/" data-id="ck89s5ldv00007c0ld2o10xls" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/" rel="tag">kubernetes</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Kubernetes-基础入门" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/27/Kubernetes-%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/" class="article-date">
  <time datetime="2020-03-27T03:15:23.000Z" itemprop="datePublished">2020-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/27/Kubernetes-%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/">Kubernetes 基础入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Kubernetes-介绍"><a href="#Kubernetes-介绍" class="headerlink" title="Kubernetes 介绍"></a>Kubernetes 介绍</h2><p>Kubernetes 是一个可移植的、可扩展的开源容器管理平台。Kubernetes 拥有一个庞大且快速增长的生态系统。其提供了一个可弹性运行分布式系统的框架。借助于容器的优势可快速实现系统扩展、故障转移和多种部署模式等</p>
<h2 id="Kuberntes-优势"><a href="#Kuberntes-优势" class="headerlink" title="Kuberntes 优势"></a>Kuberntes 优势</h2><ul>
<li><strong>简化了应用程序部署</strong></li>
<li><strong>存储编排</strong></li>
<li><strong>自动部署和回滚</strong></li>
<li><strong>健康检查和修复</strong></li>
</ul>
<h2 id="Kubernetes-架构"><a href="#Kubernetes-架构" class="headerlink" title="Kubernetes 架构"></a>Kubernetes 架构</h2><h2 id=""><a href="#" class="headerlink" title=""></a><img src="../images/kubernetes/kubernetes-Components.png" alt=""></h2><p>Kubernetes 集群由一组 Master 节点和一组Node节点组成，其中 Master 节点是集群控制节点，所有的集群操作，都经由 Master 接入，Nodes 称为工作节点，用来运行Pod。Pod是集群中最小的运行单元。</p>
<ul>
<li><strong>Api server</strong></li>
</ul>
<p>Kube-apiserver 提供一个基于 http或https的 ESTful 的API，其用来接收客户端的请求</p>
<ul>
<li><strong>Scheduler</strong></li>
</ul>
<p>kube-scheduler 通过集群中工作节点的 CPU负载、内存使用量、以及各节点上运行容器的数量，合理的将Pod 调度到合适的节点运行</p>
<ul>
<li><strong>Controller manager</strong></li>
</ul>
<p>Controller manager 用来执行管理集群的操作。如当集群中有节点出现故障时，通知Api-server进行Pod迁移或将节点从机器中踢出；Pod 的数目发生变化时，使其恢复到用户所期望的状态等</p>
<ul>
<li><strong>kubelet</strong></li>
</ul>
<p>运行在 Node节点上的代理，用来确保kuberntes 在容器在Pod中运行</p>
<ul>
<li><strong>kube-proxy</strong></li>
</ul>
<p>运行在集群中的网络代理，用来生成iptbales规则或ipvs规则。这些网络规则允许从节点在群集内部或集群外部与Pod进行网络通信</p>
<ul>
<li><strong>etcd</strong></li>
</ul>
<p>持久存储Kubernetes 集群状态</p>
<h2 id="kubectl-快速入门"><a href="#kubectl-快速入门" class="headerlink" title="kubectl 快速入门"></a>kubectl 快速入门</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 创建一个 deployment</span><br><span class="line">~]# kubectl  create deployment myapp --image&#x3D;ikubernetes&#x2F;myapp:v1</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2. 创建一个 Service</span><br><span class="line">~]# kubectl  create service clusterip myapp --tcp&#x3D;80:80</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">3. 查看 Service 的详请</span><br><span class="line">~]# kubectl  describe svc&#x2F;myapp </span><br><span class="line">Name:              myapp</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            app&#x3D;myapp</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          app&#x3D;myapp</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.97.238.149</span><br><span class="line">Port:              80-80  80&#x2F;TCP</span><br><span class="line">TargetPort:        80&#x2F;TCP</span><br><span class="line">Endpoints:         10.244.1.7:80,10.244.2.5:80</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">4. 使用域名访问,默认域名只能在集群内部访问，通过 CoreDNS 解析</span><br><span class="line">~]# dig -t A  myapp.default.svc.cluster.local. @10.96.0.10</span><br><span class="line">~]# kubectl  exec -it myapp-7b595df7fc-7pnkm -- &#x2F;bin&#x2F;sh</span><br><span class="line">&#x2F; # wget -O - -q myapp</span><br><span class="line">Hello MyApp | Version: v1 | &lt;a href&#x3D;&quot;hostname.html&quot;&gt;Pod Name&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">5. 扩容 </span><br><span class="line">~]# kubectl scale --replicas&#x3D;3 deployment myapp</span><br><span class="line">~]# kubectl  describe svc&#x2F;myapp       </span><br><span class="line">Name:              myapp</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            app&#x3D;myapp</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          app&#x3D;myapp</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.97.238.149</span><br><span class="line">Port:              80-80  80&#x2F;TCP</span><br><span class="line">TargetPort:        80&#x2F;TCP</span><br><span class="line">Endpoints:         10.244.1.7:80,10.244.1.8:80,10.244.2.5:80 + 1 more...</span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">6. 滚动升级</span><br><span class="line">~]# kubectl  set image deployment&#x2F;myapp myapp&#x3D;ikubernetes&#x2F;myapp:v2</span><br><span class="line">~]# kubectl  exec -it myapp-655ddf74b4-zxkcr -- &#x2F;bin&#x2F;sh</span><br><span class="line">&#x2F; # wget -O - -q myapp</span><br><span class="line">Hello MyApp | Version: v2 | &lt;a href&#x3D;&quot;hostname.html&quot;&gt;Pod Name&lt;&#x2F;a&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">7. 回滚</span><br><span class="line">~]# kubectl  rollout undo deployment&#x2F;myapp</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">8. 回滚到指定版本</span><br><span class="line">~]# kubectl  rollout history deployment&#x2F;myapp</span><br><span class="line">~]# kubectl  rollout undo  --to-revision&#x3D;2 deployment&#x2F;myapp</span><br></pre></td></tr></table></figure>

<h2 id="暴露服务"><a href="#暴露服务" class="headerlink" title="暴露服务"></a>暴露服务</h2><p>默认我们deployment 创建的服务是使用clusterip的模式，clusterip只允许在集群内部访问，我们我们需要在集群外部访问pod是，我们可以使用 nodePort 的方式实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl  edit svc myapp</span><br><span class="line">   type: NodePort</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl  get svc myapp</span><br><span class="line">NAME    TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">myapp   NodePort   10.97.238.149   &lt;none&gt;        80:32264&#x2F;TCP   18m</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/27/Kubernetes-%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/" data-id="ck89q8sxn0000tx0l95z984mw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kubernetes/" rel="tag">kubernetes</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Pull-an-Image-from-a-Private-Registry" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/27/Pull-an-Image-from-a-Private-Registry/" class="article-date">
  <time datetime="2020-03-27T01:55:27.000Z" itemprop="datePublished">2020-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/27/Pull-an-Image-from-a-Private-Registry/">Pull an Image from a Private Registry</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Pull-an-Image-from-a-Private-Registry"><a href="#Pull-an-Image-from-a-Private-Registry" class="headerlink" title="Pull an Image from a Private Registry"></a><a href="https://v1-16.docs.kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/" target="_blank" rel="noopener">Pull an Image from a Private Registry</a></h1><h2 id="Log-in-to-Docker"><a href="#Log-in-to-Docker" class="headerlink" title="Log in to Docker"></a>Log in to Docker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~]# docker login harbor.linux.io -u admin -p abc123</span><br><span class="line">~]# cat .docker&#x2F;config.json </span><br><span class="line">&#123;</span><br><span class="line">        &quot;auths&quot;: &#123;</span><br><span class="line">                &quot;harbor.linux.io&quot;: &#123;</span><br><span class="line">                        &quot;auth&quot;: &quot;YWRtaW46YWJjMTIz&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;HttpHeaders&quot;: &#123;</span><br><span class="line">                &quot;User-Agent&quot;: &quot;Docker-Client&#x2F;18.06.0-ce (linux)&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Create-a-Secret-by-providing-credentials-on-the-command-line"><a href="#Create-a-Secret-by-providing-credentials-on-the-command-line" class="headerlink" title="Create a Secret by providing credentials on the command line"></a>Create a Secret by providing credentials on the command line</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry regcred --docker-server&#x3D;harbor.linux.io --docker-username&#x3D;admin --docker-password&#x3D;abc123 --docker-email&#x3D;1071102039@qq.com</span><br></pre></td></tr></table></figure>



<h2 id="Inspecting-the-Secret-regcred"><a href="#Inspecting-the-Secret-regcred" class="headerlink" title="Inspecting the Secret regcred"></a>Inspecting the Secret <code>regcred</code></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl  get secret regcred -o yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  .dockerconfigjson: eyJhdXRocyI6eyJoYXJib3IubGludXguaW8iOnsidXNlcm5hbWUiOiJhZG1pbiIsInBhc3N3b3JkIjoiYWJjMTIzIiwiZW1haWwiOiIxMDcxMTAyMDM5QHFxLmNvbSIsImF1dGgiOiJZV1J0YVc0NllXSmpNVEl6In19fQ&#x3D;&#x3D;</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: &quot;2020-03-27T02:15:39Z&quot;</span><br><span class="line">  name: regcred</span><br><span class="line">  namespace: default</span><br><span class="line">  resourceVersion: &quot;68835&quot;</span><br><span class="line">  selfLink: &#x2F;api&#x2F;v1&#x2F;namespaces&#x2F;default&#x2F;secrets&#x2F;regcred</span><br><span class="line">  uid: a33772df-0ae6-4fdd-956c-0526d4a1e0a7</span><br><span class="line">type: kubernetes.io&#x2F;dockerconfigjson</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl get secret regcred --output&#x3D;&quot;jsonpath&#x3D;&#123;.data.\.dockerconfigjson&#125;&quot; | base64 --decode</span><br></pre></td></tr></table></figure>

<h2 id="Create-a-Pod-that-uses-your-Secret"><a href="#Create-a-Pod-that-uses-your-Secret" class="headerlink" title="Create a Pod that uses your Secret"></a>Create a Pod that uses your Secret</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mainfests]# cat private-reg-pod.yaml </span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: private-reg-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: private-reg-container</span><br><span class="line">    image: harbor.linux.io&#x2F;base-images&#x2F;myapp:v1</span><br><span class="line">  imagePullSecrets:</span><br><span class="line">  - name: regcred</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/27/Pull-an-Image-from-a-Private-Registry/" data-id="ck89kltsg0000w80l565b35u8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/harbor/" rel="tag">harbor</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-构建企业级镜像仓库-Harbor" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/26/%E6%9E%84%E5%BB%BA%E4%BC%81%E4%B8%9A%E7%BA%A7%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93-Harbor/" class="article-date">
  <time datetime="2020-03-26T09:05:33.000Z" itemprop="datePublished">2020-03-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/26/%E6%9E%84%E5%BB%BA%E4%BC%81%E4%B8%9A%E7%BA%A7%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93-Harbor/">构建企业级镜像仓库-Harbor_v1.10.1</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="1、-Harbor-Installation-Prerequisites"><a href="#1、-Harbor-Installation-Prerequisites" class="headerlink" title="1、 Harbor Installation Prerequisites"></a>1、 Harbor Installation Prerequisites</h2><ul>
<li><p>主机名设置：<code>~]# hostnamectl  set-hostname harbor.linux.io</code></p>
</li>
<li><p>关闭防火墙：<code>~]# for i in stop disable ;do sudo systemctl $i firewalld; done</code></p>
</li>
<li><p>关闭selinux：<code>~]# setenforce 0 &amp;&amp; sudo sed -i &quot;s/^SELINUX=enforcing/SELINUX=disabled/g&quot; /etc/selinux/config</code></p>
</li>
<li><p>时间同步：<code>*/3 * * * * /usr/sbin/ntpdate ntp.aliyun.com &gt; /dev/null</code></p>
</li>
<li><p>开启内核转发</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~]# cat &gt; &#x2F;etc&#x2F;sysctl.d&#x2F;99-kubernetes-cri.conf &lt;&lt;EOF</span><br><span class="line">net.bridge.bridge-nf-call-iptables  &#x3D; 1</span><br><span class="line">net.ipv4.ip_forward                 &#x3D; 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables &#x3D; 1</span><br><span class="line">EOF</span><br><span class="line">~]# sysctl  --system</span><br></pre></td></tr></table></figure>

<h2 id="2、Install-docker"><a href="#2、Install-docker" class="headerlink" title="2、Install docker"></a>2、Install docker</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]# yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">~]# yum-config-manager --add-repo http:&#x2F;&#x2F;mirrors.aliyun.com&#x2F;docker-ce&#x2F;linux&#x2F;centos&#x2F;docker-ce.repo</span><br><span class="line">~]# yum install -y  docker-ce-19.03.8</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~]# mkdir &#x2F;etc&#x2F;docker</span><br><span class="line">~]# mkdir -pv &#x2F;opt&#x2F;docker-root</span><br><span class="line">~]# vim &#x2F;etc&#x2F;docker&#x2F;daemon.json</span><br><span class="line">&#123;</span><br><span class="line">        &quot;registry-mirrors&quot;: [&quot;https:&#x2F;&#x2F;o4uba187.mirror.aliyuncs.com&quot;],</span><br><span class="line">        &quot;graph&quot;:  &quot;&#x2F;opt&#x2F;docker-root&quot;</span><br><span class="line">&#125;</span><br><span class="line"> ~]# for i in enable restart; do systemctl restart docker ;done</span><br></pre></td></tr></table></figure>

<h2 id="Download-the-Harbor-Installer"><a href="#Download-the-Harbor-Installer" class="headerlink" title="Download the Harbor Installer"></a>Download the Harbor Installer</h2><ul>
<li><a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">Download and Unpack the Installer</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]# wget https:&#x2F;&#x2F;github.com&#x2F;goharbor&#x2F;harbor&#x2F;releases&#x2F;download&#x2F;v1.10.1&#x2F;harbor-online-installer-v1.10.1.tgz</span><br><span class="line">~]# tar -xf harbor-online-installer-v1.10.1.tgz  -C &#x2F;opt&#x2F;</span><br></pre></td></tr></table></figure>

<ul>
<li>Install docker-compose</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]# yum install -y python3-pip</span><br><span class="line">~]# pip3 install docker-compose -i https:&#x2F;&#x2F;pypi.douban.com&#x2F;simple</span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://goharbor.io/docs/1.10/install-config/configure-https/" target="_blank" rel="noopener">Configure HTTPS Access to Harbor</a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]# mkdir &#x2F;opt&#x2F;harbor&#x2F;ssl</span><br><span class="line">~]# cd &#x2F;opt&#x2F;harbor&#x2F;ssl</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. Generate a CA certificate private key.</span><br><span class="line">ssl]# openssl genrsa -out ca.key 4096</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2. Generate the CA certificate.</span><br><span class="line">ssl]# openssl req -x509 -new -nodes -sha512 -days 3650 \</span><br><span class="line"> -subj &quot;&#x2F;C&#x3D;CN&#x2F;ST&#x3D;Beijing&#x2F;L&#x3D;Beijing&#x2F;O&#x3D;example&#x2F;OU&#x3D;Personal&#x2F;CN&#x3D;harbor.linux.io&quot; \</span><br><span class="line"> -key ca.key \</span><br><span class="line"> -out ca.crt</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">3. Generate a private key for harbor server.</span><br><span class="line">ssl]# openssl genrsa -out harbor.linux.io.key 4096</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">4. Generate a certificate signing request (CSR).</span><br><span class="line">ssl]# openssl req -sha512 -new \</span><br><span class="line">    -subj &quot;&#x2F;C&#x3D;CN&#x2F;ST&#x3D;Beijing&#x2F;L&#x3D;Beijing&#x2F;O&#x3D;example&#x2F;OU&#x3D;Personal&#x2F;CN&#x3D;harbor.linux.io&quot; \</span><br><span class="line">    -key harbor.linux.io.key \</span><br><span class="line">    -out harbor.linux.io.csr</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">5. Generate an x509 v3 extension file.</span><br><span class="line">ssl]# cat &gt; v3.ext &lt;&lt;-EOF</span><br><span class="line">authorityKeyIdentifier&#x3D;keyid,issuer</span><br><span class="line">basicConstraints&#x3D;CA:FALSE</span><br><span class="line">keyUsage &#x3D; digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span><br><span class="line">extendedKeyUsage &#x3D; serverAuth</span><br><span class="line">subjectAltName &#x3D; @alt_names</span><br><span class="line"></span><br><span class="line">[alt_names]</span><br><span class="line">DNS.1&#x3D;harbor.linux.io</span><br><span class="line">DNS.2&#x3D;harbor.linux.io</span><br><span class="line">DNS.3&#x3D;10.42.0.220</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">6. Use the v3.ext file to generate a certificate for your Harbor host.</span><br><span class="line">ssl]# openssl x509 -req -sha512 -days 3650 \</span><br><span class="line">    -extfile v3.ext \</span><br><span class="line">    -CA ca.crt -CAkey ca.key -CAcreateserial \</span><br><span class="line">    -in harbor.linux.io.csr \</span><br><span class="line">    -out harbor.linux.io.crt</span><br></pre></td></tr></table></figure>

<ul>
<li>Configure the Harbor YML File</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~]# vim &#x2F;opt&#x2F;harbor&#x2F;harbor.yml</span><br><span class="line"> #set hostname</span><br><span class="line"> hostname &#x3D; harbor.linux.io</span><br><span class="line"> #set ui_url_protocol</span><br><span class="line"> ui_url_protocol &#x3D; https</span><br><span class="line"> ......</span><br><span class="line"> #The path of cert and key files for nginx, they are applied only the protocol is set to https </span><br><span class="line"> certificate: &#x2F;opt&#x2F;harbor&#x2F;ssl&#x2F;harbor.linux.io.crt</span><br><span class="line"> private_key: &#x2F;opt&#x2F;harbor&#x2F;ssl&#x2F;harbor.linux.io.key</span><br><span class="line"> harbor_admin_password &#x3D; abc123</span><br></pre></td></tr></table></figure>

<ul>
<li>Run the <code>prepare</code> script to enable HTTPS</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]# cd &#x2F;opt&#x2F;harbor&#x2F; &amp;&amp; .&#x2F;prepare</span><br><span class="line">~]# cd &#x2F;opt&#x2F;harbor&#x2F; &amp;&amp; .&#x2F;install.sh</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. stop harbor image data remains in the file system, so no data is lost.</span><br><span class="line">~]# docker-compose down -v</span><br><span class="line">2. Restart Harbor: docker-compose up -d</span><br></pre></td></tr></table></figure>

<h2 id="Provide-the-Certificates-to-Harbor-and-Docker"><a href="#Provide-the-Certificates-to-Harbor-and-Docker" class="headerlink" title="Provide the Certificates to Harbor and Docker"></a>Provide the Certificates to Harbor and Docker</h2><ul>
<li>Convert <code>harbor.linux.crt</code> to <code>harbor.linux.io.cert</code>, for use by Docker.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssl]# openssl x509 -inform PEM -in harbor.linux.io.crt -out harbor.linux.io.cert</span><br></pre></td></tr></table></figure>



<ul>
<li>Copy the server certificate, key and CA files into the Docker certificates folder on the Harbor host.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssl]# mkdir -pv  &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;harbor.linux.io&#x2F;</span><br><span class="line">ssl]# cp harbor.linux.io.cert  &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;harbor.linux.io&#x2F;</span><br><span class="line">ssl]# cp harbor.linux.io.key  &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;harbor.linux.io&#x2F;</span><br><span class="line">ssl]# cp ca.crt  &#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;harbor.linux.io&#x2F;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]# docker login harbor.linux.io -u admin -p abc123</span><br></pre></td></tr></table></figure>

<h2 id="Upload-image-to-Harbor"><a href="#Upload-image-to-Harbor" class="headerlink" title="Upload image to Harbor"></a>Upload image to Harbor</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]# docker tag busybox:latest harbor.linux.io&#x2F;library&#x2F;busybox:v1</span><br><span class="line">~]# docker push harbor.linux.io&#x2F;library&#x2F;busybox:v1</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/03/26/%E6%9E%84%E5%BB%BA%E4%BC%81%E4%B8%9A%E7%BA%A7%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93-Harbor/" data-id="ck88pitji0000xk0lb98yf8p6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/harbor/" rel="tag">harbor</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pod/" rel="tag">Pod</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/harbor/" rel="tag">harbor</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ingress/" rel="tag">ingress</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubeadm/" rel="tag">kubeadm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kubernetes/" rel="tag">kubernetes</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Pod/" style="font-size: 10px;">Pod</a> <a href="/tags/harbor/" style="font-size: 15px;">harbor</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/ingress/" style="font-size: 10px;">ingress</a> <a href="/tags/kubeadm/" style="font-size: 10px;">kubeadm</a> <a href="/tags/kubernetes/" style="font-size: 20px;">kubernetes</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/03/29/Kuberntes%E5%AD%98%E5%82%A8%E4%B9%8BconfigMap/">Kuberntes存储之ConfigMap</a>
          </li>
        
          <li>
            <a href="/2020/03/29/Ingress%E8%B5%84%E6%BA%90/">Ingress资源</a>
          </li>
        
          <li>
            <a href="/2020/03/28/Service-%E8%B5%84%E6%BA%90%E8%AF%A6%E8%A7%A3/">Service 资源详解</a>
          </li>
        
          <li>
            <a href="/2020/03/27/Pod-Controllers-%E8%AF%A6%E8%A7%A3/">Pod Controllers 详解</a>
          </li>
        
          <li>
            <a href="/2020/03/27/Working-with-Pods/">Working with Pods</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>